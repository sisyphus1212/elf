
# Hello C Programming

* Basic Usage: <http://showterm.io/a98435fb1b79b83954775>
* Advanced Usage: <http://showterm.io/887b5ee77e3f377035d01>

## Usage

### Build with gcc and run

    $ ls
    hello.c  Makefile

    // Build with gcc and run it
    $ gcc -o hello hello.c
    $ ./hello
    hello
    $ wc -c hello
    8384 hello

### Build with make

    $ make DEFAULT=y
    gcc -Wall -Werror  -o hello hello.c
    hello
    $ wc -c hello
    8384 hello

    $ make
    gcc -fno-stack-protector -fomit-frame-pointer -fno-asynchronous-unwind-tables -fno-pie -no-pie -m32 -Wall -Werror  -o hello hello.c
    hello
    $ wc -c hello
    7184 hello

### Build intermediate files and check their file type

    // 1. hello.i: preprocessor result
    // 2. hello.s: compiling result, assembly
    // 3. hello.o: relocable object file, assembling result
    // 4. hello: executable, linking result
    $ make hello.{i,s,o}

    $ file hello.i
    hello.i: C source, ASCII text

    $ file hello.s
    hello.s: assembler source, ASCII text

    $ file hello.o
    hello.o: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), not stripped

    $ file hello
    hello: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-, for GNU/Linux 2.6.32, BuildID[sha1]=c2bd48f86121ab996d665a55a5aff7721fc38e61, not stripped
    
    $ make clean
    rm -f hello hello.o hello.s hello.i

### Build with gcc -g and debug it with gdb

    $ gcc -g -o hello hello.c
    $ gdb ./hello
    GNU gdb (Ubuntu 7.7.1-0ubuntu5~14.04.3) 7.7.1
    Reading symbols from ./hello...done.
    (gdb) l
    1	#include <stdio.h>
    2
    3	int main(int argc, char argv[])
    4	{
    5		printf("hello\n");
    6
    7		return 0;
    8	}
    (gdb) b 3
    Breakpoint 1 at 0x40053c: file hello.c, line 3.
    (gdb) b 7
    Breakpoint 2 at 0x400546: file hello.c, line 7.
    (gdb) r
    Starting program: /research/tinylab/cloud-lab/labs/linux-lab/examples/c/hello/hello

    Breakpoint 1, main (argc=1, argv=0x7fffffffe428 "\242\347\377\377\377\177") at hello.c:5
    5		printf("hello\n");
    (gdb) bt
    #0  main (argc=1, argv=0x7fffffffe428 "\242\347\377\377\377\177") at hello.c:5
    (gdb) quit
    A debugging session is active.

    	Inferior 1 [process 32518] will be killed.

    Quit anyway? (y or n) y

### Generate coredump for crash

通过往非法地址写入一个值制造一个段错误：

    	int i = 0;
    
    	scanf("%d", i);

关闭静态检查，打开段错误，编译并运行如下：

    $ make core

    or

    $ make STATIC_DETECTOR=n SEGFAULT_TEST=y
    Please input a number: 0
    Segmentation fault (core dumped)

此时，实际并未生成 core。需要配置下允许生成的 core 大小不受限制，另外，打开调试选项：

    $ ulimit -c unlimited

    $ make STATIC_DETECTOR=n SEGFAULT_TEST=y DEBUG=y
    Please input a number: 0
    Segmentation fault (core dumped)
    Makefile:29: recipe for target 'all' failed
    make: *** [all] Error 139

    $ ls
    core  hello  hello.c  Makefile  README.md

查看 core 文件类型：

    $ file core 
    core: ELF 32-bit LSB core file Intel 80386, version 1 (SYSV), SVR4-style, from 'hello'

启用 gdb 调试：

    $ gdb ./hello core
    GNU gdb (Ubuntu 8.2-0ubuntu1~16.04.1) 8.2
    Reading symbols from ./hello...done.
    [New LWP 72183]
    Core was generated by `hello'.
    Program terminated with signal SIGSEGV, Segmentation fault.
    #0  0xf75f6bc7 in _IO_vfscanf () from /lib/i386-linux-gnu/libc.so.6
    (gdb) bt
    #0  0xf75f6bc7 in _IO_vfscanf () from /lib/i386-linux-gnu/libc.so.6
    #1  0xf760013e in __isoc99_scanf () from /lib/i386-linux-gnu/libc.so.6
    #2  0x0804847a in main (argc=1, argv=0xffbb22b4) at hello.c:7
    (gdb) quit
    
    $ sed -n '7p' hello.c 
    	scanf("%d", i);

如上所示，确实能定位到是第 7 行 `scanf` 的原因。

## Options introduction

* -fno-stack-protector, no stack overwrite protecting
* -fomit-frame-pointer, not use frame pointer
* -fno-asynchronous-unwind-tables, no .eh_frame, only required for DWARF-based unwinding
* -fno-pie -no-pie, use original 32bit address
* -m32, compile for i386
* -Wall -Werror, static detector

## References

* [why .eh_frame](https://stackoverflow.com/questions/26300819/why-gcc-compiled-c-program-needs-eh-frame-section)
* [32bit abs addr](https://stackoverflow.com/questions/43367427/32-bit-absolute-addresses-no-longer-allowed-in-x86-64-linux)
* [Makefile usage](http://tinylab.org/makefile-deep-usage/)
* [Segmentation fault](http://tinylab.org/explore-linux-segmentation-fault/)

---
Copyright Reserved, Author: Wu Zhangjin, Wechat: tinylab
<http://tinylab.org/360-elf>
