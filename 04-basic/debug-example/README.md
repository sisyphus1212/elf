
# Debugging 实例分析

先确保可以正常生成 core dump 文件。

    $ ulimit -c unlimited

## Stack overflow

    $ make OVERFLOW_TEST=y hello
    gcc -m32 -DOVERFLOW_TEST -fstack-protector-all -g -o hello hello.c
    *** stack smashing detected ***: hello terminated
    Aborted (core dumped)
    Makefile:55: recipe for target 'hello' failed
    make: *** [hello] Error 134

通过 gdb 调试生成的 core：

    $ gdb ./hello core
    Core was generated by `hello'.
    Program terminated with signal SIGABRT, Aborted.
    #0  0xf77d9be9 in __kernel_vsyscall ()
    (gdb) bt
    #0  0xf77d9be9 in __kernel_vsyscall ()
    #1  0xf7622ea9 in raise () from /lib/i386-linux-gnu/libc.so.6
    #2  0xf7624407 in abort () from /lib/i386-linux-gnu/libc.so.6
    #3  0xf765e37c in ?? () from /lib/i386-linux-gnu/libc.so.6
    #4  0xf76ee708 in __fortify_fail () from /lib/i386-linux-gnu/libc.so.6
    #5  0xf76ee698 in __stack_chk_fail () from /lib/i386-linux-gnu/libc.so.6
    #6  0x08048495 in overflow_test () at hello.c:12
    #7  0x080484c5 in main (argc=1, argv=0xffdc4be4) at hello.c:29
    (gdb) l 12
    7
    8		a[3] = '5';
    9		a[10] = '5';
    10		a[50] = 'f';
    11		a[-3] = 'f';
    12	}
    13	#endif
    14
    15	#ifdef SEGFAULT_TEST
    16	void segfault_test(void)
    (gdb)

通过反汇编检查 Stack：

    $ objdump -d hello | grep -A 10 "overflow_test>:"
    08048462 <overflow_test>:
     8048462:	55                   	push   %ebp
     8048463:	89 e5                	mov    %esp,%ebp
     8048465:	83 ec 18             	sub    $0x18,%esp           --> 最大预留了 0x18 的 stack 空间
     8048468:	65 a1 14 00 00 00    	mov    %gs:0x14,%eax
     804846e:	89 45 f4             	mov    %eax,-0xc(%ebp)
     8048471:	31 c0                	xor    %eax,%eax
     8048473:	c6 45 f4 35          	movb   $0x35,-0xc(%ebp)
     8048477:	c6 45 fb 35          	movb   $0x35,-0x5(%ebp)
     804847b:	c6 45 23 66          	movb   $0x66,0x23(%ebp)     --> 写出界，0x23-0x18 > 0
     804847f:	c6 45 ee 66          	movb   $0x66,-0x12(%ebp)

## Segment fault

    $ make SEGFAULT_TEST=y hello
    gcc -m32 -DSEGFAULT_TEST -g -o hello hello.c
    hello.c: In function ‘segfault_test’:
    hello.c:21:10: warning: format ‘%d’ expects argument of type ‘int *’, but argument 2 has type ‘int’ [-Wformat=]
      scanf("%d", i);
             ~^   ~
    Please input a number: 10
    Segmentation fault (core dumped)
    Makefile:55: recipe for target 'hello' failed
    make: *** [hello] Error 139

    $ gdb ./hello core
    Core was generated by `hello'.
    Program terminated with signal SIGSEGV, Segmentation fault.
    #0  0xf75cebc7 in _IO_vfscanf () from /lib/i386-linux-gnu/libc.so.6
    (gdb) bt
    #0  0xf75cebc7 in _IO_vfscanf () from /lib/i386-linux-gnu/libc.so.6
    #1  0xf75d813e in __isoc99_scanf () from /lib/i386-linux-gnu/libc.so.6
    #2  0x080484af in segfault_test () at hello.c:21      --> 出错位置
    #3  0x080484cb in main (argc=1, argv=0xffed5e54) at hello.c:33
    (gdb) l 21
    16	void segfault_test(void)
    17	{
    18		int i = 0;
    19
    20		printf("Please input a number: ");
    21		scanf("%d", i);
    22	}
    23	#endif
    24
    25
    (gdb)

也可以通过 gdb 单步跟踪找到出错的位置：

    $ gdb ./hello
    (gdb) b segfault_test
    Breakpoint 1 at 0x8048488: file hello.c, line 18.
    (gdb) b main
    Breakpoint 2 at 0x80484c6: file hello.c, line 33.
    (gdb) r
    Starting program: /media/falcon/develop/cloud-lab/labs/linux-lab/examples/360-elf/04-basic/debug-example/hello

    Breakpoint 2, main (argc=1, argv=0xffffcb44) at hello.c:33
    33		segfault_test();
    (gdb) c
    Continuing.

    Breakpoint 1, segfault_test () at hello.c:18
    18		int i = 0;
    (gdb) n
    20		printf("Please input a number: ");
    (gdb) n
    21		scanf("%d", i);
    (gdb) n
    Please input a number: 10

    Program received signal SIGSEGV, Segmentation fault.
    0xf7e48bc7 in _IO_vfscanf () from /lib/i386-linux-gnu/libc.so.6
    (gdb) bt
    #0  0xf7e48bc7 in _IO_vfscanf () from /lib/i386-linux-gnu/libc.so.6
    #1  0xf7e5213e in __isoc99_scanf () from /lib/i386-linux-gnu/libc.so.6
    #2  0x080484af in segfault_test () at hello.c:21
    #3  0x080484cb in main (argc=1, argv=0xffffcb44) at hello.c:33
    (gdb)

如果运行时没有带符号，可以事后用 addr2line 转换得到符号：

    $ addr2line -f -a -e hello 0x080484af
    0x080484af
    segfault_test
    /labs/linux-lab/examples/360-elf/04-basic/debug-example/hello.c:21

## 延伸资料

可以同时参考作者的两篇文章：

* [Linux 段错误详解](http://tinylab.org/explore-linux-segmentation-fault/)
* [如何生成干净可阅读的汇编代码](http://tinylab.org/generate-clean-assembly/)，见 Stack Protector 部分


---
Copyright Reserved, Author: Wu Zhangjin, Wechat: tinylab
<http://tinylab.org/360-elf>
